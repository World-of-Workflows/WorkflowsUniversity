{"$id":"1","definitionId":"9d2a31a3de5e434ebda637578c535e4a","versionId":"03456735fc2a4b20a731bdadf9cb3f7c","name":"GetChangingAccessTokenAuthentication","displayName":"get AccessToken","version":1,"variables":{"$id":"2","data":{}},"customAttributes":{"$id":"3","data":{}},"isSingleton":false,"persistenceBehavior":"WorkflowBurst","deleteCompletedInstances":false,"isPublished":true,"isLatest":true,"createdAt":"2024-07-22T07:05:40.7624871Z","activities":[{"$id":"4","activityId":"3bf23f9e-e67d-4114-9f23-86a4209b26b8","type":"ObjectInstanceGet","displayName":"Get TransEliteAccessToken","x":-180,"y":180,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"5","name":"InstanceId","syntax":"JavaScript","expressions":{"$id":"6","JavaScript":"activities.getSettingToken.Output()[0].ObjectId"}},{"$id":"7","name":"VariableName","expressions":{"$id":"8","Literal":"AccessToken"}},{"$id":"9","name":"Expanded","expressions":{"$id":"10"}}],"propertyStorageProviders":{"$id":"11"}},{"$id":"12","activityId":"1f7cb27e-d582-425b-87f1-d2bd94da47a6","type":"ObjectInstanceList","name":"getSettingToken","displayName":"get setting instance for token cache","x":-380,"y":80,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"13","name":"ObjectType","syntax":"Literal","expressions":{"$id":"14","Literal":"Settings"}},{"$id":"15","name":"Filter","expressions":{"$id":"16","Literal":"Key eq 'AccessToken'"}},{"$id":"17","name":"Skip","expressions":{"$id":"18"}},{"$id":"19","name":"Limit","expressions":{"$id":"20"}},{"$id":"21","name":"OrderBy","expressions":{"$id":"22"}},{"$id":"23","name":"Expand","expressions":{"$id":"24"}}],"propertyStorageProviders":{"$id":"25"}},{"$id":"26","activityId":"1ff45d59-0d8c-4c40-8ee5-5f3e1d92c1ce","type":"If","displayName":"If access token expired","x":220,"y":240,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"27","name":"Condition","syntax":"JavaScript","expressions":{"$id":"28","JavaScript":"var t = getVariable(\"AccessToken\")\n// Assuming AccessToken.Data2 is a date string or timestamp\nconst data2 = t.Data2;\n\n// Current date and time\nconst now = new Date();\n\n// Function to check if the date is earlier than now\nfunction isEarlierThanNow(dateString) {\n    if (!dateString) {\n        // If dateString is empty or null\n        return true;\n    }\n\n    const date = new Date(dateString);\n\n    if (isNaN(date.getTime())) {\n        // If the date is invalid\n        return true;\n    }\n\n    return date < now;\n}\n\n// Check if Data2 is earlier than now\nreturn isEarlierThanNow(data2);\n//console.log(isEarlier);\n\n"}}],"propertyStorageProviders":{"$id":"29"}},{"$id":"30","activityId":"8c36eb92-bf30-4e64-9298-a705f7fd8cd9","type":"ObjectInstanceList","name":"getAPIBaseURL","displayName":"get setting instance for APIBaseURL","x":1160,"y":40,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"31","name":"ObjectType","syntax":"Literal","expressions":{"$id":"32","Literal":"Settings"}},{"$id":"33","name":"Filter","expressions":{"$id":"34","Literal":"Key eq 'APIBaseURL'"}},{"$id":"35","name":"Skip","expressions":{"$id":"36"}},{"$id":"37","name":"Limit","expressions":{"$id":"38"}},{"$id":"39","name":"OrderBy","expressions":{"$id":"40"}},{"$id":"41","name":"Expand","expressions":{"$id":"42"}}],"propertyStorageProviders":{"$id":"43"}},{"$id":"44","activityId":"75f6d037-bd16-4fc2-9b33-63606239d112","type":"ObjectInstanceGet","displayName":"Get TransEliteAPIBaseURL","x":1400,"y":80,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"45","name":"InstanceId","syntax":"JavaScript","expressions":{"$id":"46","JavaScript":"activities.getAPIBaseURL.Output()[0].ObjectId"}},{"$id":"47","name":"VariableName","expressions":{"$id":"48","Literal":"APIBaseURL"}},{"$id":"49","name":"Expanded","expressions":{"$id":"50"}}],"propertyStorageProviders":{"$id":"51"}},{"$id":"52","activityId":"cf265e05-d381-434f-9970-57af8241c975","type":"Correlate","displayName":"Correlate - new access token saved","x":2040,"y":780,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"53","name":"Value","expressions":{"$id":"54","Literal":"new access token saved"}}],"propertyStorageProviders":{"$id":"55"}},{"$id":"56","activityId":"280b3d80-0b2d-484f-9683-9b9de6474724","type":"ObjectInstanceUpdate","displayName":"Update AccessToken instance","x":2060,"y":660,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"57","name":"InstanceId","syntax":"Liquid","expressions":{"$id":"58","Liquid":"{{Variables.AccessToken.ObjectId}}"}},{"$id":"59","name":"ClearOmittedFields","expressions":{"$id":"60"}},{"$id":"61","name":"Values","syntax":"JavaScript","expressions":{"$id":"62","Json":"{\"Data1\":\"\",\"Data2\":\"\"}","JavaScript":"// Create a new Date object for the current time\nlet currentDate = new Date();\nlet mins = getVariable(\"access_token_expiry\")\n\n// Add 1 hour and 59 minutes to the current date\n// 1 hour = 60 minutes, so 1 hour and 59 minutes = 119 minutes\ncurrentDate.setMinutes(currentDate.getMinutes() + parseInt(mins));\n\nreturn {\n    \"Data1\":getVariable(\"access_token\"),\n    \"Data2\":currentDate.toISOString()\n    }"}},{"$id":"63","name":"VariableName","expressions":{"$id":"64","Literal":"AccessToken"}}],"propertyStorageProviders":{"$id":"65"}},{"$id":"66","activityId":"04e8f44d-6cce-4e4b-a085-b399bff40f35","type":"SetVariable","displayName":"Set access_token_expiry","x":1880,"y":560,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"67","name":"VariableName","expressions":{"$id":"68","Literal":"access_token_expiry"}},{"$id":"69","name":"Value","syntax":"JavaScript","expressions":{"$id":"70","JavaScript":"activities.auth.ResponseContent().expiresInMinutes"}}],"propertyStorageProviders":{"$id":"71"}},{"$id":"72","activityId":"9bf2dd4a-c49d-4272-ab31-d96084f561b2","type":"SetVariable","displayName":"Set access_token","x":1460,"y":540,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"73","name":"VariableName","expressions":{"$id":"74","Literal":"access_token"}},{"$id":"75","name":"Value","syntax":"JavaScript","expressions":{"$id":"76","JavaScript":"activities.auth.ResponseContent().authToken"}}],"propertyStorageProviders":{"$id":"77"}},{"$id":"78","activityId":"203045e0-61b3-4622-bbd7-e448dfae2267","type":"SendHttpRequest","name":"auth","displayName":"get access token","description":"/*let creds = activities.getCreds.Output()[0]\n//return 'grant_type=password&username='+creds.Data1+'&password='+creds.Data2\nreturn {\n    \"username\":creds.Data1,\n    \"password\":creds.Data2\n}\n*/\nreturn {\n \"username\": \"wow\",\n \"password\": \"******\"\n}","x":1280,"y":220,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"79","name":"Url","syntax":"JavaScript","expressions":{"$id":"80","Literal":"https://clients.hughes.com.au/TransElite.Web.Chauffeur.WebAPI.PreProd/auth","JavaScript":"getVariable(\"APIBaseURL\").Data1+\"/auth\""}},{"$id":"81","name":"Method","expressions":{"$id":"82","Literal":"POST"}},{"$id":"83","name":"Content","syntax":"Liquid","expressions":{"$id":"84","Literal":"grant_type=password&username=wow&password=*****","JavaScript":"{\n \"username\": \"wow\",\n \"password\": \"*****\"\n}","Liquid":"{\n \"username\": \"{{Variables.Creds.Data1}}\",\n \"password\": \"{{Variables.Creds.Data2}}\",\n \"accounNumber\":12000\n}"}},{"$id":"85","name":"ContentType","expressions":{"$id":"86","Literal":"application/json"}},{"$id":"87","name":"ReadContent","expressions":{"$id":"88","Literal":"true"}},{"$id":"89","name":"ResponseContentParserName","expressions":{"$id":"90","Literal":""}},{"$id":"91","name":"ResponseContentTargetType","expressions":{"$id":"92"}},{"$id":"93","name":"SupportedStatusCodes","expressions":{"$id":"94","Json":"[\"200\"]"}},{"$id":"95","name":"Authorization","expressions":{"$id":"96","Secret":"empty"}},{"$id":"97","name":"RequestHeaders","syntax":"JavaScript","expressions":{"$id":"98","Literal":"Body grant_type=password&username= XXXXXXXXXXXXXXXX&password = XXXXXXXXXXXXXXXX &accountnumber= XXXXXXXXXXXXXXXX","Liquid":"","JavaScript":""}}],"propertyStorageProviders":{"$id":"99"}},{"$id":"100","activityId":"0036bc26-9c80-4b3f-be9b-238abf0c54cf","type":"ObjectInstanceList","name":"getCreds","displayName":"get setting instance for credentials","x":600,"y":100,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"101","name":"ObjectType","syntax":"Literal","expressions":{"$id":"102","Literal":"Settings"}},{"$id":"103","name":"Filter","expressions":{"$id":"104","Literal":"Key eq 'AccessTokenCreds'"}},{"$id":"105","name":"Skip","expressions":{"$id":"106"}},{"$id":"107","name":"Limit","expressions":{"$id":"108"}},{"$id":"109","name":"OrderBy","expressions":{"$id":"110"}},{"$id":"111","name":"Expand","expressions":{"$id":"112"}}],"propertyStorageProviders":{"$id":"113"}},{"$id":"114","activityId":"79f4ab8f-7350-4dc3-98a9-c01922bd077e","type":"Finish","displayName":"Finish and return access_token","x":1980,"y":900,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"115","name":"ActivityOutput","syntax":"JavaScript","expressions":{"$id":"116","JavaScript":"getVariable(\"access_token\")"}},{"$id":"117","name":"OutcomeNames","expressions":{"$id":"118","Json":"[\"success\"]"}}],"propertyStorageProviders":{"$id":"119"}},{"$id":"120","activityId":"4fcca83c-9b41-4840-b270-acdb84fe95eb","type":"Correlate","displayName":"Correlate - new access token is blank","x":1780,"y":420,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"121","name":"Value","syntax":"JavaScript","expressions":{"$id":"122","Literal":"","JavaScript":"return activities.auth.Response().StatusCode + ' - new access token is blank'"}}],"propertyStorageProviders":{"$id":"123"}},{"$id":"124","activityId":"0e21a06e-9077-4a56-9e41-816e5fd916b5","type":"Finish","displayName":"Finish and return error","x":2340,"y":420,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"125","name":"ActivityOutput","syntax":"JavaScript","expressions":{"$id":"126","JavaScript":"return \"Unable to get access token - it was blank.  Return code \"+activities.auth.Response().StatusCode"}},{"$id":"127","name":"OutcomeNames","expressions":{"$id":"128","Json":"[\"error\"]"}}],"propertyStorageProviders":{"$id":"129"}},{"$id":"130","activityId":"32567754-bd5a-4a7f-9a18-93fc0c1f281f","type":"Finish","displayName":"Finish and return error","x":2340,"y":260,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"131","name":"ActivityOutput","syntax":"JavaScript","expressions":{"$id":"132","JavaScript":"return \"Unable to get access token.  Return code \"+activities.auth.Response().StatusCode"}},{"$id":"133","name":"OutcomeNames","expressions":{"$id":"134","Json":"[\"error\"]"}}],"propertyStorageProviders":{"$id":"135"}},{"$id":"136","activityId":"d1c88d2a-3549-412b-bcc3-a96f7b71c8c3","type":"Correlate","displayName":"Correlate - failed to get new access token","x":1780,"y":240,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"137","name":"Value","syntax":"JavaScript","expressions":{"$id":"138","Literal":"","JavaScript":"return activities.auth.Response().StatusCode + ' - failed to get new access token'"}}],"propertyStorageProviders":{"$id":"139"}},{"$id":"140","activityId":"ad66da58-5c15-4b1c-aa0f-4848249c2261","type":"If","displayName":"if we have an authToken","x":1340,"y":440,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"141","name":"Condition","syntax":"JavaScript","expressions":{"$id":"142","JavaScript":"return !isNullOrEmpty(activities.auth.ResponseContent().authToken)"}}],"propertyStorageProviders":{"$id":"143"}},{"$id":"144","activityId":"e7b00765-6f49-4e92-972d-9ef5dbeebbf5","type":"HttpEndpoint","displayName":"HTTP Endpoint /getAccessToken","x":-900,"y":-20,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"145","name":"Path","expressions":{"$id":"146","Literal":"/getAccessToken"}},{"$id":"147","name":"Methods","expressions":{"$id":"148","Json":"[\"GET\"]"}},{"$id":"149","name":"ReadContent","expressions":{"$id":"150"}},{"$id":"151","name":"TargetType","expressions":{"$id":"152"}},{"$id":"153","name":"Schema","syntax":"Literal","expressions":{"$id":"154","Literal":""}},{"$id":"155","name":"Authorize","expressions":{"$id":"156"}},{"$id":"157","name":"Policy","expressions":{"$id":"158"}},{"$id":"159","name":"AuthorizeWithCustomHeader","expressions":{"$id":"160"}},{"$id":"161","name":"CustomHeaderName","expressions":{"$id":"162"}},{"$id":"163","name":"CustomHeaderValue","expressions":{"$id":"164"}}],"propertyStorageProviders":{"$id":"165"}},{"$id":"166","activityId":"0f32150f-05b9-4f38-82fd-334909ed48dc","type":"Correlate","displayName":"Correlate - starting","x":-480,"y":-20,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"167","name":"Value","expressions":{"$id":"168","Literal":"starting to get access token"}}],"propertyStorageProviders":{"$id":"169"}},{"$id":"170","activityId":"7ab5b560-2679-427d-a359-b1db155d3c2d","type":"ObjectInstanceGet","displayName":"Get Creds","x":800,"y":140,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"171","name":"InstanceId","syntax":"JavaScript","expressions":{"$id":"172","JavaScript":"activities.getCreds.Output()[0].ObjectId"}},{"$id":"173","name":"VariableName","expressions":{"$id":"174","Literal":"Creds"}},{"$id":"175","name":"Expanded","expressions":{"$id":"176"}}],"propertyStorageProviders":{"$id":"177"}},{"$id":"178","activityId":"4d106792-45d3-4f30-8576-e1a38f98d403","type":"SetVariable","displayName":"Set access_token","x":1120,"y":900,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"179","name":"VariableName","expressions":{"$id":"180","Literal":"access_token"}},{"$id":"181","name":"Value","syntax":"JavaScript","expressions":{"$id":"182","JavaScript":"getVariable(\"AccessToken\").Data1"}}],"propertyStorageProviders":{"$id":"183"}},{"$id":"184","activityId":"82158a2e-a3ed-41ab-bc0b-96c8ffc12e64","type":"Correlate","displayName":"Correlate - using existing access token","x":600,"y":540,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"185","name":"Value","expressions":{"$id":"186","Literal":"using existing access token"}}],"propertyStorageProviders":{"$id":"187"}}],"connections":[{"$id":"188","sourceActivityId":"9bf2dd4a-c49d-4272-ab31-d96084f561b2","targetActivityId":"04e8f44d-6cce-4e4b-a085-b399bff40f35","outcome":"Done"},{"$id":"189","sourceActivityId":"1f7cb27e-d582-425b-87f1-d2bd94da47a6","targetActivityId":"3bf23f9e-e67d-4114-9f23-86a4209b26b8","outcome":"Done"},{"$id":"190","sourceActivityId":"3bf23f9e-e67d-4114-9f23-86a4209b26b8","targetActivityId":"1ff45d59-0d8c-4c40-8ee5-5f3e1d92c1ce","outcome":"Success"},{"$id":"191","sourceActivityId":"04e8f44d-6cce-4e4b-a085-b399bff40f35","targetActivityId":"280b3d80-0b2d-484f-9683-9b9de6474724","outcome":"Done"},{"$id":"192","sourceActivityId":"4d106792-45d3-4f30-8576-e1a38f98d403","targetActivityId":"79f4ab8f-7350-4dc3-98a9-c01922bd077e","outcome":"Done"},{"$id":"193","sourceActivityId":"0036bc26-9c80-4b3f-be9b-238abf0c54cf","targetActivityId":"7ab5b560-2679-427d-a359-b1db155d3c2d","outcome":"Done"},{"$id":"194","sourceActivityId":"1ff45d59-0d8c-4c40-8ee5-5f3e1d92c1ce","targetActivityId":"0036bc26-9c80-4b3f-be9b-238abf0c54cf","outcome":"True"},{"$id":"195","sourceActivityId":"e7b00765-6f49-4e92-972d-9ef5dbeebbf5","targetActivityId":"0f32150f-05b9-4f38-82fd-334909ed48dc","outcome":"Done"},{"$id":"196","sourceActivityId":"0f32150f-05b9-4f38-82fd-334909ed48dc","targetActivityId":"1f7cb27e-d582-425b-87f1-d2bd94da47a6","outcome":"Done"},{"$id":"197","sourceActivityId":"1ff45d59-0d8c-4c40-8ee5-5f3e1d92c1ce","targetActivityId":"82158a2e-a3ed-41ab-bc0b-96c8ffc12e64","outcome":"False"},{"$id":"198","sourceActivityId":"82158a2e-a3ed-41ab-bc0b-96c8ffc12e64","targetActivityId":"4d106792-45d3-4f30-8576-e1a38f98d403","outcome":"Done"},{"$id":"199","sourceActivityId":"280b3d80-0b2d-484f-9683-9b9de6474724","targetActivityId":"cf265e05-d381-434f-9970-57af8241c975","outcome":"Done"},{"$id":"200","sourceActivityId":"cf265e05-d381-434f-9970-57af8241c975","targetActivityId":"79f4ab8f-7350-4dc3-98a9-c01922bd077e","outcome":"Done"},{"$id":"201","sourceActivityId":"7ab5b560-2679-427d-a359-b1db155d3c2d","targetActivityId":"8c36eb92-bf30-4e64-9298-a705f7fd8cd9","outcome":"Success"},{"$id":"202","sourceActivityId":"75f6d037-bd16-4fc2-9b33-63606239d112","targetActivityId":"203045e0-61b3-4622-bbd7-e448dfae2267","outcome":"Success"},{"$id":"203","sourceActivityId":"8c36eb92-bf30-4e64-9298-a705f7fd8cd9","targetActivityId":"75f6d037-bd16-4fc2-9b33-63606239d112","outcome":"Done"},{"$id":"204","sourceActivityId":"d1c88d2a-3549-412b-bcc3-a96f7b71c8c3","targetActivityId":"32567754-bd5a-4a7f-9a18-93fc0c1f281f","outcome":"Done"},{"$id":"205","sourceActivityId":"203045e0-61b3-4622-bbd7-e448dfae2267","targetActivityId":"d1c88d2a-3549-412b-bcc3-a96f7b71c8c3","outcome":"Unsupported Status Code"},{"$id":"206","sourceActivityId":"4fcca83c-9b41-4840-b270-acdb84fe95eb","targetActivityId":"0e21a06e-9077-4a56-9e41-816e5fd916b5","outcome":"Done"},{"$id":"207","sourceActivityId":"ad66da58-5c15-4b1c-aa0f-4848249c2261","targetActivityId":"9bf2dd4a-c49d-4272-ab31-d96084f561b2","outcome":"True"},{"$id":"208","sourceActivityId":"ad66da58-5c15-4b1c-aa0f-4848249c2261","targetActivityId":"4fcca83c-9b41-4840-b270-acdb84fe95eb","outcome":"False"},{"$id":"209","sourceActivityId":"203045e0-61b3-4622-bbd7-e448dfae2267","targetActivityId":"ad66da58-5c15-4b1c-aa0f-4848249c2261","outcome":"200"}],"id":"03456735fc2a4b20a731bdadf9cb3f7c"}