{"$id":"1","definitionId":"903d80dbb9c1483daf43d6dc8296d51f","versionId":"64313509fb754a87adbce2109e9b1212","name":"GoogleMapsGetTimeDistance","displayName":"GoogleMapsGetTimeDistance","version":1,"variables":{"$id":"2","data":{}},"customAttributes":{"$id":"3","data":{}},"isSingleton":false,"persistenceBehavior":"Suspended","deleteCompletedInstances":false,"isPublished":true,"isLatest":true,"createdAt":"2024-08-06T23:05:57.9407968Z","activities":[{"$id":"4","activityId":"a1ce9cfa-6b06-45c5-a4f6-e6650715e90a","type":"RunJavaScript","displayName":"set up Google Maps strings","x":660,"y":380,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"5","name":"Script","syntax":"Literal","expressions":{"$id":"6","Literal":"try\n    {\n        \n    setVariable(\"destination\",getVariable(\"Parameters\").destination + ' , ' + getVariable(\"Parameters\").State);\n    setVariable(\"origin\",getVariable(\"Parameters\").origin + ' , '+ getVariable(\"Parameters\").State);\n\n    setVariable(\"direction\", getVariable(\"Parameters\").direction);\n    setVariable(\"time\",getVariable(\"Parameters\").time);\n    setVariable(\"Ref\",getVariable(\"Parameters\").Ref);\n    setOutcome(\"ok\")\n    } \ncatch\n {\n    setOutcome(\"fail\")\n}\n"}},{"$id":"7","name":"PossibleOutcomes","expressions":{"$id":"8","Json":"[\"ok\",\"fail\"]"}}],"propertyStorageProviders":{"$id":"9"}},{"$id":"10","activityId":"b8b9ac3e-67fa-4bab-999a-bcc5ab1c5fe7","type":"SetVariable","displayName":"get Parameters","description":"eg\n\"destination_addresses\" : \n   [\n      \"109 Arden St, Coogee NSW 2034, Australia\"\n   ],\n   \"origin_addresses\" : \n   [\n      \"29 Undercliff Rd, Freshwater NSW 2096, Australia\"\n   ],","x":300,"y":80,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"11","name":"VariableName","expressions":{"$id":"12","Literal":"Parameters"}},{"$id":"13","name":"Value","syntax":"JavaScript","expressions":{"$id":"14","JavaScript":"JSON.parse(getVariable(\"GetInput\") ?? '')"}}],"propertyStorageProviders":{"$id":"15"}},{"$id":"16","activityId":"bec0543d-79d6-4d62-8b54-c248a482f723","type":"SetVariable","displayName":"Set GetInput","x":240,"y":-20,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"17","name":"VariableName","expressions":{"$id":"18","Literal":"GetInput"}},{"$id":"19","name":"Value","syntax":"JavaScript","expressions":{"$id":"20","JavaScript":"input"}}],"propertyStorageProviders":{"$id":"21"}},{"$id":"22","activityId":"03e6eb51-4e4b-4b72-b9bc-9bf7fdd5d5e4","type":"RunJavaScript","displayName":"convert time to utcTimeInSeconds","x":1480,"y":500,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"23","name":"Script","syntax":"Literal","expressions":{"$id":"24","Literal":"try{\n    // Create a Date object for 9:00 AM on October 28, 2023, Sydney time\n    //const sydneyTime = new Date('2023-10-28T09:00:00+11:00');\n    const sydneyTime = new Date(getVariable(\"time\"));\n\n    // Get the timezone offset in minutes and convert it to milliseconds\n    // Note: The getTimezoneOffset() method returns the difference in minutes\n    // between UTC and local time. For AEST (UTC+10), it returns -600.\n    // For AEDT (UTC+11), it returns -660.\n    const timezoneOffset = sydneyTime.getTimezoneOffset() * 60000;\n\n    setVariable(\"timezoneOffset\",timezoneOffset)\n    // Convert Sydney time to UTC time in milliseconds since Unix epoch\n    const utcTimeInMilliseconds = sydneyTime.getTime() - timezoneOffset;\n\n    // You can create a new Date object for the UTC time if needed\n    const utcDateTime = new Date(utcTimeInMilliseconds);\n\n\n    // Convert the time to UTC time in seconds since Unix epoch\n    const utcTimeInSeconds = Math.floor(utcTimeInMilliseconds / 1000);\n\n    setVariable(\"output\",getVariable(\"time\")+` Sydney time corresponds to ${utcTimeInSeconds} seconds since the Unix epoch (UTC).`);\n\n    setVariable(\"utcTimeInSeconds\",utcTimeInSeconds)\n    setVariable(\"utcDateTime\",utcDateTime)\n    setOutcome(\"ok\")\n} catch {\n    setOutcome(\"fail\")\n}\n"}},{"$id":"25","name":"PossibleOutcomes","expressions":{"$id":"26","Json":"[\"ok\",\"fail\"]"}}],"propertyStorageProviders":{"$id":"27"}},{"$id":"28","activityId":"90ab27d1-e385-454b-a684-5039643b477d","type":"SendHttpRequest","name":"getTimeDistance","displayName":"get from Google Maps","x":1700,"y":620,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"29","name":"Url","syntax":"Liquid","expressions":{"$id":"30","Liquid":"https://maps.googleapis.com/maps/api/distancematrix/json?destinations={{Variables.destination}}&origins={{Variables.origin}}&units=metric&key={{Variables.GoogleMapsKey}}&{{Variables.direction}}={{Variables.utcTimeInSeconds}}"}},{"$id":"31","name":"Method","expressions":{"$id":"32","Literal":"GET"}},{"$id":"33","name":"Content","expressions":{"$id":"34","Literal":""}},{"$id":"35","name":"ContentType","expressions":{"$id":"36","Literal":"application/json"}},{"$id":"37","name":"ReadContent","expressions":{"$id":"38","Literal":"true"}},{"$id":"39","name":"ResponseContentParserName","expressions":{"$id":"40","Literal":""}},{"$id":"41","name":"ResponseContentTargetType","expressions":{"$id":"42"}},{"$id":"43","name":"SupportedStatusCodes","expressions":{"$id":"44"}},{"$id":"45","name":"Authorization","expressions":{"$id":"46","Secret":"empty"}},{"$id":"47","name":"RequestHeaders","expressions":{"$id":"48"}}],"propertyStorageProviders":{"$id":"49"}},{"$id":"50","activityId":"7b991632-0f7a-42dc-b4d5-10144ecf08a9","type":"RunJavaScript","displayName":"find return values","x":2020,"y":880,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"51","name":"Script","syntax":"Literal","expressions":{"$id":"52","Literal":"function findValue(obj, keyToFind) {\n  let value;\n  if (Array.isArray(obj)) {\n    for (let i = 0; i < obj.length; i++) {\n      value = findValue(obj[i], keyToFind);\n      if (value !== undefined) {\n        return value;\n      }\n    }\n  } else {\n    for (let key in obj) {\n      if (key === keyToFind) {\n        return obj[key];\n      }\n      if (typeof obj[key] === 'object') {\n        value = findValue(obj[key], keyToFind);\n        if (value !== undefined) {\n          return value;\n        }\n      }\n    }\n  }\n  return value;\n}\ntry {\n\n      const jsonData = activities.getTimeDistance.ResponseContent()\n\n      if (jsonData.status == \"OK\") {\n      //const durationInTraffic = findValue(jsonData, 'duration_in_traffic');\n      //const durationInTrafficValue = durationInTraffic ? durationInTraffic.value : 'Not Found';\n      const durationInTrafficValue = jsonData.rows[0].elements[0].duration_in_traffic.value;\n\n      //const distance = findValue(jsonData, 'distance');\n      const distanceValue = jsonData.rows[0].elements[0].distance.value;\n\n      setVariable(\"durationInTrafficValue\",durationInTrafficValue)\n      setVariable(\"distanceValue\",distanceValue)\n      setOutcome(\"OK\")\n    } else {\n      setOutcome(\"bad response\")\n      setVariable(\"MapsError\", jsonData.status + \" : \"+ jsonData.error_messge)\n      setVariable(\"durationInTrafficValue\",0)\n      setVariable(\"distanceValue\",0)   \n    }\n} catch {\n      setOutcome(\"fault\")\n      setVariable(\"MapsError\", \"caught error\")\n      setVariable(\"durationInTrafficValue\",0)\n      setVariable(\"distanceValue\",0)\n}"}},{"$id":"53","name":"PossibleOutcomes","expressions":{"$id":"54","Json":"[\"OK\",\"bad response\",\"fault\"]"}}],"propertyStorageProviders":{"$id":"55"}},{"$id":"56","activityId":"390ad9a5-911c-4c84-8165-ed1674de6711","type":"WriteLine","displayName":"parameters: destination, origin, Ref, time, direction, State","x":400,"y":220,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"57","name":"Text","expressions":{"$id":"58"}}],"propertyStorageProviders":{"$id":"59"}},{"$id":"60","activityId":"47bfe084-8bb3-4ca3-81a9-93ea628103f8","type":"SetVariable","displayName":"Set GoogleMapsKey","x":1620,"y":260,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"61","name":"VariableName","expressions":{"$id":"62","Literal":"GoogleMapsKey"}},{"$id":"63","name":"Value","syntax":"JavaScript","expressions":{"$id":"64","JavaScript":"try {activities.ListGMK.Output()[0].Data1}\ncatch {}"}}],"propertyStorageProviders":{"$id":"65"}},{"$id":"66","activityId":"bf09417a-5e98-4698-8197-c3abef6804e9","type":"Correlate","displayName":"Correlate","x":1220,"y":500,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"67","name":"Value","syntax":"JavaScript","expressions":{"$id":"68","JavaScript":"let r = getVariable(\"Ref\") + ' - ' + getVariable(\"origin\") + ' to '+ getVariable(\"destination\") + ' at ' \nr += getVariable(\"time\");\nreturn r"}}],"propertyStorageProviders":{"$id":"69"}},{"$id":"70","activityId":"23d9b0d0-ccf2-429c-a8c9-8386df27de67","type":"If","displayName":"if Duration > 200 minutes","x":1960,"y":1120,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"71","name":"Condition","syntax":"JavaScript","expressions":{"$id":"72","JavaScript":"return (Math.round(getVariable(\"durationInTrafficValue\")/60) > 200)"}}],"propertyStorageProviders":{"$id":"73"}},{"$id":"74","activityId":"5ea18baf-2612-4e40-8239-c44a85216057","type":"ObjectInstanceList","name":"ListGMK","displayName":"List GoogleMapsKey settings 0 or 1","x":1120,"y":280,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"75","name":"ObjectType","syntax":"Literal","expressions":{"$id":"76","Literal":"Settings"}},{"$id":"77","name":"Filter","expressions":{"$id":"78","Literal":"Key eq 'GoogleMapsKey'"}},{"$id":"79","name":"Skip","expressions":{"$id":"80"}},{"$id":"81","name":"Limit","expressions":{"$id":"82","Literal":"1"}},{"$id":"83","name":"OrderBy","expressions":{"$id":"84"}},{"$id":"85","name":"Expand","expressions":{"$id":"86"}}],"propertyStorageProviders":{"$id":"87"}},{"$id":"88","activityId":"3ae595b9-4eec-4d3d-bfe9-7be2bb8680e6","type":"Fault","displayName":"Fault","x":1140,"y":660,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"89","name":"Message","expressions":{"$id":"90","Literal":"time is null"}}],"propertyStorageProviders":{"$id":"91"}},{"$id":"92","activityId":"c4c472be-b540-4f05-88cb-44d29a67ba81","type":"Fault","displayName":"Fault","x":1240,"y":380,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"93","name":"Message","expressions":{"$id":"94","Literal":"bad parameters"}}],"propertyStorageProviders":{"$id":"95"}},{"$id":"96","activityId":"508be649-bfb5-4879-8953-b14a51870a70","type":"Fault","displayName":"Fault","x":1620,"y":360,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"97","name":"Message","expressions":{"$id":"98","Literal":"no GoogleMapsKey for APIKey"}}],"propertyStorageProviders":{"$id":"99"}},{"$id":"100","activityId":"16f9b1c7-e347-42fe-bfe8-43c3aec7999a","type":"SetVariable","displayName":"Set mapsResponse","x":1800,"y":760,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"101","name":"VariableName","expressions":{"$id":"102","Literal":"mapsResponse"}},{"$id":"103","name":"Value","syntax":"JavaScript","expressions":{"$id":"104","JavaScript":"activities.getTimeDistance.ResponseContent()"}}],"propertyStorageProviders":{"$id":"105"}},{"$id":"106","activityId":"b9fbb7e5-792a-4b4a-9474-40c6445e6007","type":"Correlate","displayName":"Correlate","x":2040,"y":980,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"107","name":"Value","syntax":"JavaScript","expressions":{"$id":"108","JavaScript":"let r = getVariable(\"Ref\") + ' - ' + getVariable(\"origin\") + ' to '+ getVariable(\"destination\") + ' at ' \nr += getVariable(\"time\");\nr += \" duration:\"+ Math.round(getVariable(\"durationInTrafficValue\")/60) + \" minutes\"\n\nreturn r"}}],"propertyStorageProviders":{"$id":"109"}},{"$id":"110","activityId":"7c25fa7c-480b-4bd9-ad07-4cce8b294c23","type":"Correlate","displayName":"Correlate","x":2440,"y":800,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"111","name":"Value","syntax":"JavaScript","expressions":{"$id":"112","JavaScript":"let r = getVariable(\"Ref\") + ' - ' + getVariable(\"origin\") + ' to '+ getVariable(\"destination\") + ' at ' \nr += getVariable(\"time\");\nr += \" - MapsError: \"+getVariable(\"MapsError\")\n\nreturn r"}}],"propertyStorageProviders":{"$id":"113"}},{"$id":"114","activityId":"c42a4c93-0bb9-4523-b17e-1b5d8404bea2","type":"RunWorkflow","displayName":"Run Workflow CreateBackgoundTask","x":2400,"y":1040,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"115","name":"WorkflowDefinitionId","syntax":"JavaScript","expressions":{"$id":"116","JavaScript":"getWorkflowDefinitionIdByName(\"CreateBackgoundTask\")"}},{"$id":"117","name":"Input","syntax":"JavaScript","expressions":{"$id":"118","JavaScript":"let o = \"**\"+getVariable(\"origin\")+\"**\"\nlet d = \"**\"+getVariable(\"destination\")+\"**\"\nlet tt = Math.round(getVariable(\"durationInTrafficValue\")/60)\nlet message = {\n    \"ErrorSummary\":\"The estimated duration from a trip was \"+tt.toString()+ \" minutes\",\n    \"ErrorDetail\":\"We just asked Google Maps for the time between \\n\"+o+ \" and \\n\"+d+\". \\n\\nSometimes Google Maps translates an address and looks for the wrong place.  \\n\\nIf **\"+tt.toString()+ \" minutes** is wrong for this trip, it will be because Google Maps did not understand the *origin* or the *destination*. \\n\\n\\n To resolve this you likely need to create a *LOCALITY* in World of Workflows.   Use the with just the *SUBURB* of either \\n-the *ORIGIN* \"+o+\" or \\n-the *DESTINATION* \"+d+ \". \\nin in the *ADDRESS* field.  The *DESCRIPTION* will be an address of the locality that Google Maps can find.\\n\\n\\nThe Details contains the response from Google Maps.  The value used is *duration_in_traffic*.\",\n    \"JSONDetails\":getVariable(\"mapsResponse\")\n}\nreturn {\n    \"Message\":message\n}"}},{"$id":"119","name":"PossibleOutcomes","expressions":{"$id":"120"}},{"$id":"121","name":"Mode","expressions":{"$id":"122","Literal":"DispatchAndForget"}},{"$id":"123","name":"TenantId","expressions":{"$id":"124"}},{"$id":"125","name":"CorrelationId","expressions":{"$id":"126"}},{"$id":"127","name":"ContextId","expressions":{"$id":"128"}},{"$id":"129","name":"CustomAttributes","expressions":{"$id":"130"}},{"$id":"131","name":"RetryFailedActivities","expressions":{"$id":"132"}}],"propertyStorageProviders":{"$id":"133"}},{"$id":"134","activityId":"3cd407a0-85ac-4477-af16-1ceae5e66e2d","type":"Finish","displayName":"Finish and return Minutes and KM","x":3040,"y":1200,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"135","name":"ActivityOutput","syntax":"JavaScript","expressions":{"$id":"136","JavaScript":"return {\n    \"durationInTrafficMinutes\": Math.round(getVariable(\"durationInTrafficValue\")/60),\n    \"distanceKM\":Math.round(getVariable(\"distanceValue\")/10)/100\n}\n","Liquid":"[\n    \"durationInTrafficValue\":{{Variables.durationInTrafficValue}},\n    \"distanceValue\":{{Variables.distanceValue}}\n]\n"}},{"$id":"137","name":"OutcomeNames","expressions":{"$id":"138"}}],"propertyStorageProviders":{"$id":"139"}},{"$id":"140","activityId":"16fff984-7d5e-4373-965c-0c0b8d57616d","type":"If","displayName":"if time is valid","x":900,"y":520,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"141","name":"Condition","syntax":"JavaScript","expressions":{"$id":"142","JavaScript":"if(isNullOrEmpty(getVariable(\"time\"))) return false\nreturn true"}}],"propertyStorageProviders":{"$id":"143"}}],"connections":[{"$id":"144","sourceActivityId":"b8b9ac3e-67fa-4bab-999a-bcc5ab1c5fe7","targetActivityId":"390ad9a5-911c-4c84-8165-ed1674de6711","outcome":"Done"},{"$id":"145","sourceActivityId":"390ad9a5-911c-4c84-8165-ed1674de6711","targetActivityId":"a1ce9cfa-6b06-45c5-a4f6-e6650715e90a","outcome":"Done"},{"$id":"146","sourceActivityId":"03e6eb51-4e4b-4b72-b9bc-9bf7fdd5d5e4","targetActivityId":"90ab27d1-e385-454b-a684-5039643b477d","outcome":"ok"},{"$id":"147","sourceActivityId":"90ab27d1-e385-454b-a684-5039643b477d","targetActivityId":"16f9b1c7-e347-42fe-bfe8-43c3aec7999a","outcome":"Done"},{"$id":"148","sourceActivityId":"16f9b1c7-e347-42fe-bfe8-43c3aec7999a","targetActivityId":"7b991632-0f7a-42dc-b4d5-10144ecf08a9","outcome":"Done"},{"$id":"149","sourceActivityId":"bf09417a-5e98-4698-8197-c3abef6804e9","targetActivityId":"03e6eb51-4e4b-4b72-b9bc-9bf7fdd5d5e4","outcome":"Done"},{"$id":"150","sourceActivityId":"bec0543d-79d6-4d62-8b54-c248a482f723","targetActivityId":"b8b9ac3e-67fa-4bab-999a-bcc5ab1c5fe7","outcome":"Done"},{"$id":"151","sourceActivityId":"5ea18baf-2612-4e40-8239-c44a85216057","targetActivityId":"47bfe084-8bb3-4ca3-81a9-93ea628103f8","outcome":"Done"},{"$id":"152","sourceActivityId":"a1ce9cfa-6b06-45c5-a4f6-e6650715e90a","targetActivityId":"5ea18baf-2612-4e40-8239-c44a85216057","outcome":"ok"},{"$id":"153","sourceActivityId":"47bfe084-8bb3-4ca3-81a9-93ea628103f8","targetActivityId":"16fff984-7d5e-4373-965c-0c0b8d57616d","outcome":"Done"},{"$id":"154","sourceActivityId":"b9fbb7e5-792a-4b4a-9474-40c6445e6007","targetActivityId":"23d9b0d0-ccf2-429c-a8c9-8386df27de67","outcome":"Done"},{"$id":"155","sourceActivityId":"23d9b0d0-ccf2-429c-a8c9-8386df27de67","targetActivityId":"c42a4c93-0bb9-4523-b17e-1b5d8404bea2","outcome":"True"},{"$id":"156","sourceActivityId":"23d9b0d0-ccf2-429c-a8c9-8386df27de67","targetActivityId":"3cd407a0-85ac-4477-af16-1ceae5e66e2d","outcome":"Done"},{"$id":"157","sourceActivityId":"a1ce9cfa-6b06-45c5-a4f6-e6650715e90a","targetActivityId":"c4c472be-b540-4f05-88cb-44d29a67ba81","outcome":"fail"},{"$id":"158","sourceActivityId":"5ea18baf-2612-4e40-8239-c44a85216057","targetActivityId":"508be649-bfb5-4879-8953-b14a51870a70","outcome":"Object type not found"},{"$id":"159","sourceActivityId":"7b991632-0f7a-42dc-b4d5-10144ecf08a9","targetActivityId":"b9fbb7e5-792a-4b4a-9474-40c6445e6007","outcome":"OK"},{"$id":"160","sourceActivityId":"7b991632-0f7a-42dc-b4d5-10144ecf08a9","targetActivityId":"7c25fa7c-480b-4bd9-ad07-4cce8b294c23","outcome":"bad response"},{"$id":"161","sourceActivityId":"7b991632-0f7a-42dc-b4d5-10144ecf08a9","targetActivityId":"7c25fa7c-480b-4bd9-ad07-4cce8b294c23","outcome":"fault"},{"$id":"162","sourceActivityId":"7c25fa7c-480b-4bd9-ad07-4cce8b294c23","targetActivityId":"3cd407a0-85ac-4477-af16-1ceae5e66e2d","outcome":"Done"},{"$id":"163","sourceActivityId":"16fff984-7d5e-4373-965c-0c0b8d57616d","targetActivityId":"bf09417a-5e98-4698-8197-c3abef6804e9","outcome":"True"},{"$id":"164","sourceActivityId":"16fff984-7d5e-4373-965c-0c0b8d57616d","targetActivityId":"3ae595b9-4eec-4d3d-bfe9-7be2bb8680e6","outcome":"False"}],"id":"64313509fb754a87adbce2109e9b1212"}