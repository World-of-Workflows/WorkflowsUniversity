{"$id":"1","definitionId":"fc515559ab764f5b9e0cfc65cd1012fd","versionId":"831bd965b57f43d4b8afdce70f69c611","name":"CallMyAPI","displayName":"Call an API that has a refreshing token","version":2,"variables":{"$id":"2","data":{}},"customAttributes":{"$id":"3","data":{}},"isSingleton":false,"persistenceBehavior":"WorkflowBurst","deleteCompletedInstances":false,"isPublished":false,"isLatest":true,"createdAt":"2024-07-22T07:40:37.0999696Z","activities":[{"$id":"4","activityId":"d82c4442-8b03-4944-905a-bcfa6410da75","type":"ObjectInstanceList","name":"getAPIBaseURL","displayName":"get setting instance for APIBaseURL","x":1020,"y":380,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"5","name":"ObjectType","syntax":"Literal","expressions":{"$id":"6","Literal":"Settings"}},{"$id":"7","name":"Filter","expressions":{"$id":"8","Literal":"Key eq 'APIBaseURL'"}},{"$id":"9","name":"Skip","expressions":{"$id":"10"}},{"$id":"11","name":"Limit","expressions":{"$id":"12"}},{"$id":"13","name":"OrderBy","expressions":{"$id":"14"}},{"$id":"15","name":"Expand","expressions":{"$id":"16"}}],"propertyStorageProviders":{"$id":"17"}},{"$id":"18","activityId":"dac57bf4-4bba-4633-bcc5-fb3ffda9bd53","type":"WriteHttpResponse","displayName":"HTTP Response - not found","x":760,"y":640,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"19","name":"Content","syntax":"JavaScript","expressions":{"$id":"20","JavaScript":"\"not found\""}},{"$id":"21","name":"ContentType","expressions":{"$id":"22","Literal":"text/plain"}},{"$id":"23","name":"StatusCode","expressions":{"$id":"24","Literal":"OK"}},{"$id":"25","name":"CharSet","expressions":{"$id":"26","Literal":"utf-8"}},{"$id":"27","name":"ResponseHeaders","expressions":{"$id":"28"}}],"propertyStorageProviders":{"$id":"29"}},{"$id":"30","activityId":"d8e02bd5-9dbd-4ce9-9a76-36d0fa014d37","type":"RunWorkflow","name":"getAuthToken","displayName":"Run Workflow GetChangingAccessTokenAuthentication","x":200,"y":480,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"31","name":"WorkflowDefinitionId","syntax":"JavaScript","expressions":{"$id":"32","Liquid":"","JavaScript":"return getWorkflowDefinitionIdByName(\"GetChangingAccessTokenAuthentication\")"}},{"$id":"33","name":"Input","expressions":{"$id":"34"}},{"$id":"35","name":"PossibleOutcomes","expressions":{"$id":"36","Json":"[\"success\",\"error\"]"}},{"$id":"37","name":"Mode","expressions":{"$id":"38","Literal":"Blocking"}},{"$id":"39","name":"TenantId","expressions":{"$id":"40"}},{"$id":"41","name":"CorrelationId","expressions":{"$id":"42"}},{"$id":"43","name":"ContextId","expressions":{"$id":"44"}},{"$id":"45","name":"CustomAttributes","expressions":{"$id":"46"}},{"$id":"47","name":"RetryFailedActivities","expressions":{"$id":"48"}}],"propertyStorageProviders":{"$id":"49"}},{"$id":"50","activityId":"d576bd89-dd0d-4e9b-9bc5-0a931fcd51b0","type":"Correlate","displayName":"Correlate - failed to get new access token","x":80,"y":700,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"51","name":"Value","syntax":"JavaScript","expressions":{"$id":"52","Literal":"","JavaScript":"return activities.getAuthToken.Output().workflowOutput + ' - failed to get new access token'"}}],"propertyStorageProviders":{"$id":"53"}},{"$id":"54","activityId":"ae35031e-b08d-497f-866b-d76720a505c1","type":"ObjectInstanceGet","displayName":"Get AccessToken","x":300,"y":180,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"55","name":"InstanceId","syntax":"JavaScript","expressions":{"$id":"56","JavaScript":"activities.getSettingToken.Output()[0].ObjectId"}},{"$id":"57","name":"VariableName","expressions":{"$id":"58","Literal":"AccessToken"}},{"$id":"59","name":"Expanded","expressions":{"$id":"60"}}],"propertyStorageProviders":{"$id":"61"}},{"$id":"62","activityId":"825ecaa8-a662-4997-8567-4dff11d438a5","type":"If","displayName":"If access token expired","x":500,"y":280,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"63","name":"Condition","syntax":"JavaScript","expressions":{"$id":"64","JavaScript":"var t = getVariable(\"AccessToken\")\n// Assuming TransEliteAccessToken.Data2 is a date string or timestamp\nconst data2 = t.Data2;\n\n// Current date and time\nconst now = new Date();\n\n// Function to check if the date is earlier than now\nfunction isEarlierThanNow(dateString) {\n    if (!dateString) {\n        // If dateString is empty or null\n        return true;\n    }\n\n    const date = new Date(dateString);\n\n    if (isNaN(date.getTime())) {\n        // If the date is invalid\n        return true;\n    }\n\n    return date < now;\n}\n\n// Check if .Data2 is earlier than now\nreturn isEarlierThanNow(data2);\n//console.log(isEarlier);\n\n"}}],"propertyStorageProviders":{"$id":"65"}},{"$id":"66","activityId":"f6c40443-d84e-41a5-8462-7832e2e57782","type":"SetVariable","displayName":"Set access_token","x":920,"y":220,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"67","name":"VariableName","expressions":{"$id":"68","Literal":"access_token"}},{"$id":"69","name":"Value","syntax":"JavaScript","expressions":{"$id":"70","JavaScript":"getVariable(\"AccessToken\").Data1"}}],"propertyStorageProviders":{"$id":"71"}},{"$id":"72","activityId":"151efa33-f465-4279-97de-97defab50bec","type":"ObjectInstanceList","name":"getSettingToken","displayName":"get setting instance for token cache","x":100,"y":80,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"73","name":"ObjectType","syntax":"Literal","expressions":{"$id":"74","Literal":"Settings"}},{"$id":"75","name":"Filter","expressions":{"$id":"76","Literal":"Key eq 'AccessToken'"}},{"$id":"77","name":"Skip","expressions":{"$id":"78"}},{"$id":"79","name":"Limit","expressions":{"$id":"80"}},{"$id":"81","name":"OrderBy","expressions":{"$id":"82"}},{"$id":"83","name":"Expand","expressions":{"$id":"84"}}],"propertyStorageProviders":{"$id":"85"}},{"$id":"86","activityId":"87768d79-a6a0-486f-b902-696f7c4eb31e","type":"SetVariable","displayName":"Set access_token","x":700,"y":520,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"87","name":"VariableName","expressions":{"$id":"88","Literal":"access_token"}},{"$id":"89","name":"Value","syntax":"JavaScript","expressions":{"$id":"90","JavaScript":"activities.getAuthToken.Output().workflowOutput"}}],"propertyStorageProviders":{"$id":"91"}},{"$id":"92","activityId":"14ec87bd-8989-4061-8d39-3ce6174b72c3","type":"Finish","displayName":"Finish and return data","x":1854,"y":1048,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"93","name":"ActivityOutput","syntax":"JavaScript","expressions":{"$id":"94","JavaScript":"JSON.stringify(activities.httpAPI.ResponseContent(),null,2)"}},{"$id":"95","name":"OutcomeNames","expressions":{"$id":"96","Json":"[\"success\"]"}}],"propertyStorageProviders":{"$id":"97"}},{"$id":"98","activityId":"5b54239e-87e8-418f-b61a-2cf52f1ee462","type":"Correlate","displayName":"Correlate - finished - bad","x":1974,"y":728,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"99","name":"Value","syntax":"JavaScript","expressions":{"$id":"100","Literal":"","JavaScript":"return 'error: '+getVariable(\"Method2\")+\" \"+getVariable(\"api\") +\" - \"+ activities.httpAPI.Response().StatusCode.toString()\n"}}],"propertyStorageProviders":{"$id":"101"}},{"$id":"102","activityId":"4cd08e2b-43d6-403a-8691-fe778860b2bd","type":"Correlate","displayName":"Correlate - finished","x":1494,"y":908,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"103","name":"Value","syntax":"JavaScript","expressions":{"$id":"104","Literal":"","JavaScript":"return 'finished '+getVariable(\"Method2\")+\" \"+getVariable(\"api\") "}}],"propertyStorageProviders":{"$id":"105"}},{"$id":"106","activityId":"e3d67a3f-cf9c-4f3e-b682-738c21036d2e","type":"SetVariable","displayName":"Set ErrorResponse","x":2114,"y":828,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"107","name":"VariableName","expressions":{"$id":"108","Literal":"ErrorResponse"}},{"$id":"109","name":"Value","syntax":"JavaScript","expressions":{"$id":"110","JavaScript":"activities.httpAPI.Response()"}}],"propertyStorageProviders":{"$id":"111"}},{"$id":"112","activityId":"cbea033e-fd64-42f3-b203-2684af8eed28","type":"Finish","displayName":"Finish and return error","x":2254,"y":1088,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"113","name":"ActivityOutput","syntax":"JavaScript","expressions":{"$id":"114","JavaScript":"JSON.stringify(activities.httpAPI.Response().StatusCode.toString() + \" - \" + getVariable(\"ErrorResponseContent\"))"}},{"$id":"115","name":"OutcomeNames","expressions":{"$id":"116","Json":"[\"error\"]"}}],"propertyStorageProviders":{"$id":"117"}},{"$id":"118","activityId":"f87379f3-ad85-433d-b922-4bdcb1883186","type":"SetVariable","displayName":"Set ErrorResponseContent","x":2274,"y":948,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"119","name":"VariableName","expressions":{"$id":"120","Literal":"ErrorResponseContent"}},{"$id":"121","name":"Value","syntax":"JavaScript","expressions":{"$id":"122","JavaScript":"activities.httpAPI.ResponseContent()"}}],"propertyStorageProviders":{"$id":"123"}},{"$id":"124","activityId":"ca5af952-98fa-4c0d-9532-2e60b3e5fe7c","type":"SendHttpRequest","name":"httpAPI","displayName":"Send HTTP Request - api","description":"JSON.parse(JSON.stringify(getVariable(\"Content2\")))\n\n//getVariable(\"TransEliteCustomerBookingBaseURL\").Data2+getVariable(\"api\")","x":1440,"y":680,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"125","name":"Url","syntax":"JavaScript","expressions":{"$id":"126","Literal":" https://clients.hughes.com.au/TransElite.Web.CustomerBookingAPI.PreProd/api/State","JavaScript":"getVariable(\"BaseURL\").Data1+getVariable(\"api\")"}},{"$id":"127","name":"Method","syntax":"JavaScript","expressions":{"$id":"128","Literal":"POST","JavaScript":"getVariable(\"Method\")"}},{"$id":"129","name":"Content","syntax":"JavaScript","expressions":{"$id":"130","Literal":"{\n\"PortId\": 1\n}","JavaScript":"getVariable(\"Content\")\n","Liquid":"{{Variables.Content2 | json  | raw }}"}},{"$id":"131","name":"ContentType","expressions":{"$id":"132","Literal":"application/json"}},{"$id":"133","name":"ReadContent","expressions":{"$id":"134","Literal":"true"}},{"$id":"135","name":"ResponseContentParserName","expressions":{"$id":"136","Literal":""}},{"$id":"137","name":"ResponseContentTargetType","expressions":{"$id":"138"}},{"$id":"139","name":"SupportedStatusCodes","expressions":{"$id":"140","Json":"[\"200\"]"}},{"$id":"141","name":"Authorization","syntax":"Liquid","expressions":{"$id":"142","Secret":"empty","Liquid":"Bearer {{Variables.access_token}}"}},{"$id":"143","name":"RequestHeaders","syntax":"Liquid","expressions":{"$id":"144","Literal":"Body grant_type=password&username= XXXXXXXXXXXXXXXX&password = XXXXXXXXXXXXXXXX &accountnumber= XXXXXXXXXXXXXXXX","Liquid":""}}],"propertyStorageProviders":{"$id":"145"}},{"$id":"146","activityId":"47b55d77-1752-4027-a608-279ee7c4b00a","type":"ObjectInstanceGet","displayName":"Get BaseURL","x":1240,"y":460,"persistWorkflow":false,"loadWorkflowContext":false,"saveWorkflowContext":false,"properties":[{"$id":"147","name":"InstanceId","syntax":"JavaScript","expressions":{"$id":"148","JavaScript":"activities.getAPIBaseURL.Output()[0].ObjectId"}},{"$id":"149","name":"VariableName","expressions":{"$id":"150","Literal":"APIBaseURL"}},{"$id":"151","name":"Expanded","expressions":{"$id":"152"}}],"propertyStorageProviders":{"$id":"153"}}],"connections":[{"$id":"154","sourceActivityId":"87768d79-a6a0-486f-b902-696f7c4eb31e","targetActivityId":"d82c4442-8b03-4944-905a-bcfa6410da75","outcome":"Done"},{"$id":"155","sourceActivityId":"d8e02bd5-9dbd-4ce9-9a76-36d0fa014d37","targetActivityId":"87768d79-a6a0-486f-b902-696f7c4eb31e","outcome":"success"},{"$id":"156","sourceActivityId":"d82c4442-8b03-4944-905a-bcfa6410da75","targetActivityId":"47b55d77-1752-4027-a608-279ee7c4b00a","outcome":"Done"},{"$id":"157","sourceActivityId":"f6c40443-d84e-41a5-8462-7832e2e57782","targetActivityId":"d82c4442-8b03-4944-905a-bcfa6410da75","outcome":"Done"},{"$id":"158","sourceActivityId":"d8e02bd5-9dbd-4ce9-9a76-36d0fa014d37","targetActivityId":"dac57bf4-4bba-4633-bcc5-fb3ffda9bd53","outcome":"Not Found"},{"$id":"159","sourceActivityId":"d8e02bd5-9dbd-4ce9-9a76-36d0fa014d37","targetActivityId":"d576bd89-dd0d-4e9b-9bc5-0a931fcd51b0","outcome":"error"},{"$id":"160","sourceActivityId":"825ecaa8-a662-4997-8567-4dff11d438a5","targetActivityId":"d8e02bd5-9dbd-4ce9-9a76-36d0fa014d37","outcome":"True"},{"$id":"161","sourceActivityId":"ae35031e-b08d-497f-866b-d76720a505c1","targetActivityId":"825ecaa8-a662-4997-8567-4dff11d438a5","outcome":"Success"},{"$id":"162","sourceActivityId":"151efa33-f465-4279-97de-97defab50bec","targetActivityId":"ae35031e-b08d-497f-866b-d76720a505c1","outcome":"Done"},{"$id":"163","sourceActivityId":"825ecaa8-a662-4997-8567-4dff11d438a5","targetActivityId":"f6c40443-d84e-41a5-8462-7832e2e57782","outcome":"False"},{"$id":"164","sourceActivityId":"47b55d77-1752-4027-a608-279ee7c4b00a","targetActivityId":"ca5af952-98fa-4c0d-9532-2e60b3e5fe7c","outcome":"Success"},{"$id":"165","sourceActivityId":"ca5af952-98fa-4c0d-9532-2e60b3e5fe7c","targetActivityId":"4cd08e2b-43d6-403a-8691-fe778860b2bd","outcome":"200"},{"$id":"166","sourceActivityId":"ca5af952-98fa-4c0d-9532-2e60b3e5fe7c","targetActivityId":"5b54239e-87e8-418f-b61a-2cf52f1ee462","outcome":"Unsupported Status Code"},{"$id":"167","sourceActivityId":"4cd08e2b-43d6-403a-8691-fe778860b2bd","targetActivityId":"14ec87bd-8989-4061-8d39-3ce6174b72c3","outcome":"Done"},{"$id":"168","sourceActivityId":"5b54239e-87e8-418f-b61a-2cf52f1ee462","targetActivityId":"e3d67a3f-cf9c-4f3e-b682-738c21036d2e","outcome":"Done"},{"$id":"169","sourceActivityId":"e3d67a3f-cf9c-4f3e-b682-738c21036d2e","targetActivityId":"f87379f3-ad85-433d-b922-4bdcb1883186","outcome":"Done"},{"$id":"170","sourceActivityId":"f87379f3-ad85-433d-b922-4bdcb1883186","targetActivityId":"cbea033e-fd64-42f3-b203-2684af8eed28","outcome":"Done"}],"id":"831bd965b57f43d4b8afdce70f69c611"}